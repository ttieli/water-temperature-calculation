<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水温混合计算器</title>
    <style>
        :root {
            /* 控件高度和圆角统一变量 */
            --control-height: 54px;
            --control-radius: 18px;
            --button-radius: 20px;
            --number-btn-size: 54px;
            --number-btn-radius: 12px;
        }

        @media (max-width: 480px) {
            :root {
                --control-height: 50px;
                --number-btn-size: 50px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif, 'Apple Color Emoji';
            background: linear-gradient(135deg, #E0F7FA 0%, #81D4FA 50%, #4FC3F7 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 波浪背景层 */
        body::before {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M0,0 C150,60 350,0 600,50 C850,100 1050,40 1200,80 L1200,120 L0,120 Z' fill='%2329B6F6' fill-opacity='0.3'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
            opacity: 0.4;
            pointer-events: none;
            animation: wave 10s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% {
                transform: translateX(0) translateY(0);
            }
            50% {
                transform: translateX(-25px) translateY(-10px);
            }
        }

        /* 响应式气泡动画 */
        .bubble {
            position: fixed;
            bottom: -100px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(129, 212, 250, 0.3));
            border-radius: 50%;
            opacity: 0.6;
            pointer-events: none;
            animation: rise 15s infinite ease-in;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .bubble:nth-child(1) {
            left: 10%;
            width: 40px;
            height: 40px;
            animation-delay: 0s;
            animation-duration: 12s;
        }

        .bubble:nth-child(2) {
            left: 25%;
            width: 60px;
            height: 60px;
            animation-delay: 2s;
            animation-duration: 15s;
        }

        .bubble:nth-child(3) {
            left: 50%;
            width: 30px;
            height: 30px;
            animation-delay: 4s;
            animation-duration: 10s;
        }

        .bubble:nth-child(4) {
            left: 75%;
            width: 50px;
            height: 50px;
            animation-delay: 1s;
            animation-duration: 13s;
        }

        .bubble:nth-child(5) {
            left: 90%;
            width: 35px;
            height: 35px;
            animation-delay: 3s;
            animation-duration: 11s;
        }

        @media (max-width: 768px) {
            .bubble:nth-child(1), .bubble:nth-child(2) {
                width: 30px;
                height: 30px;
            }
            .bubble:nth-child(3), .bubble:nth-child(4), .bubble:nth-child(5) {
                width: 20px;
                height: 20px;
            }
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                opacity: 0;
                transform: translateX(0) scale(1);
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                bottom: 110vh;
                opacity: 0;
                transform: translateX(100px) scale(0.5);
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 30px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(79, 195, 247, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.9);
            position: relative;
            animation: bounceIn 0.6s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }


        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            60% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #0288D1 0%, #0097A7 50%, #00ACC1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 35px;
            font-size: 32px;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(79, 195, 247, 0.2);
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 26px;
                margin-bottom: 25px;
            }
        }

        .input-group {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #0288D1;
            font-weight: 700;
            font-size: 15px;
        }

        @media (max-width: 480px) {
            label {
                font-size: 14px;
            }
        }

        .section-title {
            display: block;
            color: #0097A7;
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 15px;
            padding-left: 5px;
            border-left: 4px solid #4FC3F7;
            padding-left: 12px;
        }

        input {
            width: 100%;
            height: var(--control-height);
            padding: 0 16px;
            border: 3px solid #B3E5FC;
            border-radius: var(--control-radius);
            font-size: 16px;
            transition: all 0.3s ease;
            background: #F1F8FB;
            line-height: normal;
        }

        /* 数字输入框样式 - 隐藏原生上下按键 */
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
            -moz-appearance: textfield;
        }

        /* 隐藏浏览器默认的上下按键 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }

        input:focus {
            outline: none;
            border-color: #0288D1;
            box-shadow: 0 0 0 4px rgba(2, 136, 209, 0.15), 0 4px 12px rgba(2, 136, 209, 0.2);
            /* 移除 transform，避免Safari下的布局偏移 */
        }

        @media (max-width: 480px) {
            input {
                padding: 0 14px;
                font-size: 15px;
            }
        }

        .unit {
            color: #0097A7;
            font-size: 15px;
            margin-left: 5px;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .unit {
                font-size: 14px;
            }
        }

        button {
            width: 100%;
            height: var(--control-height);
            padding: 0 20px;
            background: linear-gradient(135deg, #0288D1 0%, #0097A7 100%);
            color: white;
            border: none;
            border-radius: var(--button-radius);
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(2, 136, 209, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: normal;
        }

        /* 主操作按钮专用样式 */
        .primary-button {
            margin-top: 15px;
        }

        @media (max-width: 480px) {
            button {
                font-size: 18px;
            }
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            box-shadow: 0 12px 30px rgba(2, 136, 209, 0.4), 0 4px 12px rgba(2, 136, 209, 0.3);
        }

        button:active {
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.25);
        }

        .result {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%);
            border-radius: 25px;
            display: none;
            border: 3px solid #81D4FA;
            transition: all 0.3s ease;
        }

        @media (max-width: 480px) {
            .result {
                padding: 20px;
            }
        }

        .result.show {
            display: block;
            animation: slideInBounce 0.5s ease-out;
        }

        @keyframes slideInBounce {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            60% {
                opacity: 1;
                transform: translateY(5px) scale(1.02);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        .result h2 {
            background: linear-gradient(135deg, #0288D1 0%, #0097A7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            font-size: 22px;
            text-align: center;
            font-weight: 800;
        }

        @media (max-width: 480px) {
            .result h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }
        }

        /* 温度指示器 */
        .temp-indicator {
            margin-bottom: 25px;
            text-align: center;
        }

        .temp-bar-container {
            position: relative;
            width: 100%;
            height: 50px;
            background: linear-gradient(to right,
                #29B6F6 0%,
                #4FC3F7 20%,
                #26A69A 40%,
                #66BB6A 60%,
                #FFB74D 80%,
                #FF6E40 100%);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .temp-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 70%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.8);
            transition: left 0.5s ease-out;
            z-index: 2;
        }

        .temp-marker::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .temp-value {
            display: block;
            margin-top: 12px;
            font-size: 18px;
            font-weight: 800;
            color: #0288D1;
        }

        /* 水位指示器 */
        .water-level {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .water-cup {
            position: relative;
            width: 80px;
            height: 120px;
            background: linear-gradient(to bottom,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0.5) 100%);
            border: 3px solid #0288D1;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        /* 热水层 - 在底部 */
        .water-hot {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top,
                rgba(255, 87, 34, 0.85) 0%,
                rgba(255, 152, 0, 0.75) 100%);
            transition: height 0.8s ease-out;
            z-index: 1;
        }

        /* 冷水层 - 在热水上面 */
        .water-cold {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top,
                rgba(3, 169, 244, 0.85) 0%,
                rgba(129, 212, 250, 0.75) 100%);
            transition: height 0.8s ease-out 0.1s;
            z-index: 2;
        }

        @keyframes waterWave {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        .water-info {
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.8;
        }

        .water-info .volume-total {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .water-info .volume-total strong {
            color: #0288D1;
            font-size: 17px;
            font-weight: 700;
            display: inline-block;
        }

        .water-info .volume-detail {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
        }

        @media (max-width: 480px) {
            .water-info {
                font-size: 13px;
            }

            .water-info .volume-total {
                font-size: 14px;
            }

            .water-info .volume-total strong {
                font-size: 16px;
            }

            .water-info .volume-detail {
                font-size: 12px;
            }
        }

        .hot-water-info,
        .cold-water-info {
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.6;
        }

        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .color-indicator.hot {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.9) 0%, rgba(255, 152, 0, 0.8) 100%);
            box-shadow: 0 1px 3px rgba(255, 87, 34, 0.4);
        }

        .color-indicator.cold {
            background: linear-gradient(135deg, rgba(3, 169, 244, 0.9) 0%, rgba(129, 212, 250, 0.8) 100%);
            box-shadow: 0 1px 3px rgba(3, 169, 244, 0.4);
        }

        .hot-water-info strong,
        .cold-water-info strong {
            color: #0288D1;
            font-weight: 700;
            display: inline-block;
            font-size: inherit;
        }

        .step {
            background: white;
            padding: 18px;
            border-radius: 18px;
            margin-bottom: 15px;
            border: 3px solid #B3E5FC;
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .step:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
        }

        .step:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 480px) {
            .step {
                padding: 14px;
                gap: 10px;
            }
        }

        .step-number {
            flex-shrink: 0;
            background: linear-gradient(135deg, #0288D1 0%, #0097A7 100%);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(2, 136, 209, 0.3);
        }

        .step:nth-child(1) .step-number {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
        }

        .step:nth-child(2) .step-number {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
        }

        .step:nth-child(3) .step-number {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
        }

        @media (max-width: 480px) {
            .step-number {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }

        .step-content {
            flex: 1;
            color: #333;
            font-size: 16px;
            font-weight: 700;
            line-height: 1.6;
            word-break: break-word;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
            min-height: 36px;
        }

        @media (max-width: 480px) {
            .step-content {
                font-size: 14px;
                min-height: 32px;
            }

            .temp-tag {
                font-size: 0.85em;
                padding: 2px 10px;
                margin: 0 3px;
            }
        }

        /* 步骤内容的温度标签样式 - 使用温度色谱系统 */
        .temp-tag {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 800;
            margin: 0 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: white;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            vertical-align: middle;
            white-space: nowrap;
            line-height: 1.4;
        }

        /* 温度色谱：根据温度动态设置颜色 */
        /* 极冷 0-30°C - 深蓝色 */
        .temp-tag.temp-very-cold {
            background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
            color: white;
        }

        /* 冷 30-50°C - 蓝色 */
        .temp-tag.temp-cold {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
            color: white;
        }

        /* 温 50-70°C - 青绿色 */
        .temp-tag.temp-warm {
            background: linear-gradient(135deg, #26A69A 0%, #00897B 100%);
            color: white;
        }

        /* 热 70-85°C - 橙色 */
        .temp-tag.temp-hot {
            background: linear-gradient(135deg, #FFB74D 0%, #FB8C00 100%);
            color: white;
        }

        /* 极热 85-100°C - 橙红色 */
        .temp-tag.temp-very-hot {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
            color: white;
        }

        .error {
            color: #D32F2F;
            text-align: center;
            padding: 18px;
            background: #FFEBEE;
            border-radius: 18px;
            margin-top: 15px;
            display: none;
            font-weight: 700;
            border: 3px solid #EF9A9A;
            animation: shake 0.5s ease;
        }

        @media (max-width: 480px) {
            .error {
                padding: 14px;
                font-size: 14px;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .error.show {
            display: block;
        }

        /* ====== 水声计时器样式 ====== */
        .water-timer-container {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #FFF8E1 0%, #FFE082 100%);
            border-radius: 25px;
            border: 3px solid #FFD54F;
        }

        @media (max-width: 480px) {
            .water-timer-container {
                padding: 20px;
                margin-top: 25px;
            }
        }

        .timer-title {
            text-align: center;
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 800;
        }

        @media (max-width: 480px) {
            .timer-title {
                font-size: 20px;
                margin-bottom: 20px;
            }
        }

        .timer-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            background: white;
            font-weight: 700;
            font-size: 14px;
            color: #666;
        }

        .timer-status.active {
            background: linear-gradient(135deg, #C8E6C9 0%, #A5D6A7 100%);
            color: #2E7D32;
            animation: pulse 2s ease-in-out infinite;
        }

        .timer-status.warning {
            background: linear-gradient(135deg, #FFCCBC 0%, #FFAB91 100%);
            color: #D84315;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .timer-time {
            font-size: 56px;
            font-weight: 800;
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            letter-spacing: 3px;
        }

        @media (max-width: 480px) {
            .timer-time {
                font-size: 42px;
            }
        }

        .timer-target {
            margin-top: 8px;
            font-size: 14px;
            color: #F57C00;
            font-weight: 600;
        }

        /* 音量指示器 */
        .volume-indicator {
            margin-bottom: 20px;
        }

        .volume-label {
            display: block;
            margin-bottom: 8px;
            color: #F57C00;
            font-size: 13px;
            font-weight: 700;
        }

        .volume-bar-container {
            position: relative;
            width: 100%;
            height: 30px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .volume-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #FFC107 75%, #FF5722 100%);
            transition: width 0.1s ease-out;
            border-radius: 15px;
        }

        .volume-threshold-line {
            position: absolute;
            left: 30%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(244, 81, 30, 0.6);
            z-index: 1;
        }

        .volume-threshold-label {
            position: absolute;
            left: 30%;
            top: -20px;
            transform: translateX(-50%);
            font-size: 11px;
            color: #F57C00;
            font-weight: 600;
        }

        /* 控制按钮组 */
        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .timer-btn {
            flex: 1;
            height: var(--control-height);
            padding: 0 20px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .timer-btn.primary {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
        }

        .timer-btn.primary:hover {
            box-shadow: 0 6px 20px rgba(67, 160, 71, 0.4);
        }

        .timer-btn.primary:disabled {
            background: linear-gradient(135deg, #BDBDBD 0%, #9E9E9E 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .timer-btn.danger {
            background: linear-gradient(135deg, #EF5350 0%, #E53935 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(229, 57, 53, 0.3);
        }

        .timer-btn.danger:hover {
            box-shadow: 0 6px 20px rgba(229, 57, 53, 0.4);
        }

        .timer-btn.secondary {
            background: white;
            color: #F57C00;
            border: 3px solid #FFD54F;
        }

        .timer-btn.secondary:hover {
            background: #FFF8E1;
            border-color: #F57C00;
        }

        @media (max-width: 480px) {
            .timer-btn {
                font-size: 14px;
                padding: 0 16px;
            }
        }

        /* 目标时长设置 */
        .target-duration {
            margin-bottom: 20px;
        }

        .duration-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .duration-preset-btn {
            padding: 8px 16px;
            background: white;
            color: #F57C00;
            border: 2px solid #FFD54F;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .duration-preset-btn:hover {
            background: #FFF8E1;
            border-color: #F57C00;
        }

        .duration-preset-btn.active {
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            color: white;
            border-color: #F57C00;
        }

        /* 历史记录 */
        .history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #FFD54F;
        }

        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: #F57C00;
            margin-bottom: 12px;
        }

        .history-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-duration {
            font-weight: 700;
            color: #F57C00;
        }

        .history-time {
            color: #999;
            font-size: 12px;
        }

        .no-history {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        /* 提醒动画 */
        @keyframes alertPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(244, 81, 30, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(244, 81, 30, 0);
            }
        }

        .alert-active {
            animation: alertPulse 1s ease-out infinite;
        }

        /* 校准功能样式 */
        .calibration-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #FFD54F;
        }

        .calibration-title {
            font-size: 14px;
            font-weight: 700;
            color: #F57C00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calibration-toggle {
            padding: 6px 12px;
            background: white;
            color: #F57C00;
            border: 2px solid #FFD54F;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .calibration-toggle:hover {
            background: #FFF8E1;
            border-color: #F57C00;
        }

        .calibration-toggle.active {
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            color: white;
        }

        .calibration-content {
            display: none;
            margin-top: 15px;
        }

        .calibration-content.show {
            display: block;
            animation: fadeInUp 0.3s ease-out;
        }

        .flow-rate-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .flow-rate-card {
            background: white;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #FFD54F;
        }

        .flow-rate-card.hot {
            border-color: #FFAB91;
        }

        .flow-rate-card.cold {
            border-color: #81D4FA;
        }

        .flow-rate-label {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .flow-rate-label.hot {
            color: #F4511E;
        }

        .flow-rate-label.cold {
            color: #0288D1;
        }

        .flow-rate-value {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .flow-rate-value.hot {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .flow-rate-value.cold {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .flow-rate-unit {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .calibration-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .calibration-mode-btn {
            flex: 1;
            padding: 10px;
            background: white;
            color: #F57C00;
            border: 2px solid #FFD54F;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .calibration-mode-btn:hover {
            background: #FFF8E1;
            border-color: #F57C00;
        }

        .calibration-mode-btn.active.hot {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
            color: white;
            border-color: #F4511E;
        }

        .calibration-mode-btn.active.cold {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
            color: white;
            border-color: #0288D1;
        }

        .calibration-input-group {
            margin-bottom: 15px;
        }

        .calibration-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #F57C00;
            font-weight: 700;
            font-size: 13px;
        }

        .calibration-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calibration-input-wrapper input {
            flex: 1;
            height: var(--control-height);
            padding: 0 16px;
            border: 2px solid #FFD54F;
            border-radius: 12px;
            font-size: 16px;
            background: white;
        }

        .calibration-input-wrapper input:focus {
            border-color: #F57C00;
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.15);
        }

        .calibration-result {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #FFD54F;
            text-align: center;
        }

        .calibration-result-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .calibration-result-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #F57C00 0%, #FF6F00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calibration-actions {
            display: flex;
            gap: 8px;
        }

        .calibration-btn {
            flex: 1;
            height: 44px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calibration-btn.start {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            color: white;
        }

        .calibration-btn.start:hover {
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.3);
        }

        .calibration-btn.save {
            background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%);
            color: white;
        }

        .calibration-btn.save:hover {
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
        }

        .calibration-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .smart-mode-card {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #81C784;
            margin-top: 15px;
        }

        .smart-mode-title {
            font-size: 13px;
            font-weight: 700;
            color: #2E7D32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .smart-mode-info {
            font-size: 12px;
            color: #558B2F;
            line-height: 1.6;
        }

        .smart-mode-info strong {
            color: #2E7D32;
            font-weight: 700;
        }

        @media (max-width: 480px) {
            .flow-rate-display {
                grid-template-columns: 1fr;
            }

            .calibration-mode-selector {
                flex-direction: column;
            }
        }

        .advanced {
            border-top: 3px dashed #B3E5FC;
            padding-top: 25px;
            margin-top: 25px;
        }

        @media (max-width: 480px) {
            .advanced {
                padding-top: 20px;
                margin-top: 20px;
            }
        }

        .advanced-title {
            color: #0097A7;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 18px;
            font-weight: 800;
        }

        @media (max-width: 480px) {
            .advanced-title {
                font-size: 12px;
                margin-bottom: 15px;
            }
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .option-button {
            flex: 1;
            min-width: 80px;
            height: var(--control-height);
            padding: 0 20px;
            background: white;
            color: #0288D1;
            border: 3px solid #B3E5FC;
            border-radius: var(--control-radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: var(--control-height);
            -webkit-appearance: none;
            appearance: none;
        }

        @media (max-width: 480px) {
            .option-button {
                min-width: 70px;
                padding: 0 16px;
                font-size: 14px;
            }
        }

        .option-button:hover:not(.active) {
            background: #E1F5FE;
            border-color: #0288D1;
            box-shadow: 0 4px 15px rgba(2, 136, 209, 0.25), 0 2px 8px rgba(2, 136, 209, 0.15);
        }

        .option-button:active {
            box-shadow: 0 1px 4px rgba(2, 136, 209, 0.15);
        }

        .option-button.active {
            background: linear-gradient(135deg, #0288D1 0%, #0097A7 100%);
            color: white;
            border-color: #0288D1;
            box-shadow: 0 6px 20px rgba(2, 136, 209, 0.3), 0 2px 10px rgba(2, 136, 209, 0.2);
            animation: pulse 0.6s ease;
        }

        /* 温度按钮色阶：冷→蓝、温→青绿、热→橙红 */
        .option-button[onclick*="45"] {
            color: #0288D1;
            border-color: #B3E5FC;
            position: relative;
        }

        .option-button[onclick*="45"]:hover:not(.active) {
            background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%);
            border-color: #0288D1;
            box-shadow: 0 0 15px rgba(41, 182, 246, 0.4);
        }

        .option-button[onclick*="45"].active {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
            color: white;
            border-color: #0288D1;
            animation: pulseBlue 1.5s ease-in-out infinite;
        }

        @keyframes pulseBlue {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(2, 136, 209, 0.3);
            }
            50% {
                box-shadow: 0 6px 30px rgba(2, 136, 209, 0.5), 0 0 20px rgba(41, 182, 246, 0.3);
            }
        }

        .option-button[onclick*="70"] {
            color: #00897B;
            border-color: #B2DFDB;
        }

        .option-button[onclick*="70"]:hover:not(.active) {
            background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
            border-color: #00897B;
            box-shadow: 0 0 15px rgba(38, 166, 154, 0.4);
        }

        .option-button[onclick*="70"].active {
            background: linear-gradient(135deg, #26A69A 0%, #00897B 100%);
            color: white;
            border-color: #00897B;
            animation: pulseTeal 1.5s ease-in-out infinite;
        }

        @keyframes pulseTeal {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(0, 137, 123, 0.3);
            }
            50% {
                box-shadow: 0 6px 30px rgba(0, 137, 123, 0.5), 0 0 20px rgba(38, 166, 154, 0.3);
            }
        }

        .option-button[onclick*="80"] {
            color: #F4511E;
            border-color: #FFCCBC;
        }

        .option-button[onclick*="80"]:hover:not(.active) {
            background: linear-gradient(135deg, #FBE9E7 0%, #FFCCBC 100%);
            border-color: #F4511E;
            box-shadow: 0 0 15px rgba(255, 110, 64, 0.4);
        }

        .option-button[onclick*="80"].active {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
            color: white;
            border-color: #F4511E;
            animation: pulseOrange 1.5s ease-in-out infinite;
        }

        @keyframes pulseOrange {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(244, 81, 30, 0.3);
            }
            50% {
                box-shadow: 0 6px 30px rgba(244, 81, 30, 0.5), 0 0 20px rgba(255, 110, 64, 0.3);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .custom-input {
            display: none;
            margin-top: 10px;
        }

        .custom-input.show {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 自定义数字输入框容器 */
        .number-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .number-input-wrapper input {
            flex: 1;
            height: var(--control-height);
            line-height: normal;
        }

        /* 自定义左右按钮 */
        .number-controls {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-shrink: 0;
        }

        .number-btn {
            width: var(--number-btn-size);
            height: var(--number-btn-size);
            border: none;
            border-radius: var(--number-btn-radius);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            line-height: var(--number-btn-size);
            margin-top: 0; /* 防御性重置：覆盖任何全局按钮的外边距 */
        }

        /* 减少按钮（降温/减小） - 冷色调 */
        .number-btn.decrease {
            background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%);
            box-shadow: 0 2px 8px rgba(2, 136, 209, 0.3);
        }

        .number-btn.decrease:hover {
            background: linear-gradient(135deg, #0288D1 0%, #01579B 100%);
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.5), 0 2px 6px rgba(2, 136, 209, 0.3);
        }

        .number-btn.decrease:active {
            box-shadow: 0 1px 4px rgba(2, 136, 209, 0.3);
        }

        /* 增加按钮（升温/增大） - 暖色调 */
        .number-btn.increase {
            background: linear-gradient(135deg, #FF6E40 0%, #F4511E 100%);
            box-shadow: 0 2px 8px rgba(244, 81, 30, 0.3);
        }

        .number-btn.increase:hover {
            background: linear-gradient(135deg, #F4511E 0%, #D84315 100%);
            box-shadow: 0 4px 12px rgba(244, 81, 30, 0.5), 0 2px 6px rgba(244, 81, 30, 0.3);
        }

        .number-btn.increase:active {
            box-shadow: 0 1px 4px rgba(244, 81, 30, 0.3);
        }

        /* 容量按钮 - 中性青色 */
        .number-btn.volume-decrease {
            background: linear-gradient(135deg, #26A69A 0%, #00897B 100%);
            box-shadow: 0 2px 8px rgba(0, 137, 123, 0.3);
        }

        .number-btn.volume-decrease:hover {
            background: linear-gradient(135deg, #00897B 0%, #00695C 100%);
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.5), 0 2px 6px rgba(0, 137, 123, 0.3);
        }

        .number-btn.volume-decrease:active {
            box-shadow: 0 1px 4px rgba(0, 137, 123, 0.3);
        }

        .number-btn.volume-increase {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            box-shadow: 0 2px 8px rgba(67, 160, 71, 0.3);
        }

        .number-btn.volume-increase:hover {
            background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.5), 0 2px 6px rgba(67, 160, 71, 0.3);
        }

        .number-btn.volume-increase:active {
            box-shadow: 0 1px 4px rgba(67, 160, 71, 0.3);
        }

        @media (max-width: 480px) {
            .number-btn {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- 气泡动画元素 -->
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>

    <div class="container">
        <h1>水温混合计算器</h1>

        <div class="input-group">
            <label class="temp-label">期望水温 <span class="unit">°C</span></label>
            <div class="button-group">
                <button type="button" class="option-button active" onclick="selectTemp(45, event)">45°C</button>
                <button type="button" class="option-button" onclick="selectTemp(70, event)">70°C</button>
                <button type="button" class="option-button" onclick="selectTemp(80, event)">80°C</button>
                <button type="button" class="option-button" onclick="selectTemp('custom', event)">自定义</button>
            </div>
            <div class="custom-input" id="customTempInput">
                <div class="number-input-wrapper">
                    <input type="number" id="targetTemp" placeholder="请输入期望温度(0-100°C)" value="45" step="1" min="0" max="100">
                    <div class="number-controls">
                        <button type="button" class="number-btn decrease" onclick="changeValue('targetTemp', -1)">−</button>
                        <button type="button" class="number-btn increase" onclick="changeValue('targetTemp', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label class="cup-label">杯子容量 <span class="unit">毫升</span></label>
            <div class="button-group">
                <button type="button" class="option-button active" onclick="selectCup(1500, event)">1500ml</button>
                <button type="button" class="option-button" onclick="selectCup(400, event)">400ml</button>
                <button type="button" class="option-button" onclick="selectCup('custom', event)">自定义</button>
            </div>
            <div class="custom-input" id="customCupInput">
                <div class="number-input-wrapper">
                    <input type="number" id="cupSize" placeholder="请输入杯子容量" value="1500" step="50" min="100">
                    <div class="number-controls">
                        <button type="button" class="number-btn volume-decrease" onclick="changeValue('cupSize', -50)">−</button>
                        <button type="button" class="number-btn volume-increase" onclick="changeValue('cupSize', 50)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="advanced">
            <div class="advanced-title">高级设置</div>

            <div class="input-group">
                <label class="hot-label">热水温度 <span class="unit">°C</span></label>
                <div class="number-input-wrapper">
                    <input type="number" id="hotTemp" value="100" step="1" min="0" max="100">
                    <div class="number-controls">
                        <button type="button" class="number-btn decrease" onclick="changeValue('hotTemp', -1)">−</button>
                        <button type="button" class="number-btn increase" onclick="changeValue('hotTemp', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="cold-label">凉水温度 <span class="unit">°C</span></label>
                <div class="number-input-wrapper">
                    <input type="number" id="coldTemp" value="20" step="1" min="0" max="100">
                    <div class="number-controls">
                        <button type="button" class="number-btn decrease" onclick="changeValue('coldTemp', -1)">−</button>
                        <button type="button" class="number-btn increase" onclick="changeValue('coldTemp', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <button class="primary-button" onclick="calculate()">计算</button>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <h2>计算结果</h2>

            <!-- 温度指示器 -->
            <div class="temp-indicator">
                <div class="temp-bar-container">
                    <div class="temp-marker" id="tempMarker"></div>
                </div>
                <span class="temp-value" id="tempValue">45°C</span>
            </div>

            <!-- 水位指示器 -->
            <div class="water-level">
                <div class="water-cup">
                    <div class="water-hot" id="waterHot"></div>
                    <div class="water-cold" id="waterCold"></div>
                </div>
                <div class="water-info" id="waterInfo">
                    <div class="volume-total">总容量: <strong id="totalVolume">1500ml</strong></div>
                    <div class="volume-detail">
                        <div class="hot-water-info">
                            <span class="color-indicator hot"></span>
                            热水: <strong id="hotWaterAmount">0ml</strong> (<span id="hotWaterPercent">0%</span>)
                        </div>
                        <div class="cold-water-info">
                            <span class="color-indicator cold"></span>
                            冷水: <strong id="coldWaterAmount">0ml</strong> (<span id="coldWaterPercent">0%</span>)
                        </div>
                    </div>
                </div>
            </div>

            <h2>操作步骤</h2>
            <div class="step">
                <span class="step-number">1</span>
                <span class="step-content" id="step1"></span>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <span class="step-content" id="step2"></span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span class="step-content" id="step3"></span>
            </div>
        </div>

        <!-- 水声计时器 -->
        <div class="water-timer-container">
            <h2 class="timer-title">🎤 水声计时器</h2>

            <!-- 状态显示 -->
            <div class="timer-status" id="timerStatus">
                请先启用麦克风权限
            </div>

            <!-- 计时显示 -->
            <div class="timer-display">
                <div class="timer-time" id="timerTime">00:00.0</div>
                <div class="timer-target" id="timerTarget">目标时长: 未设置</div>
            </div>

            <!-- 音量指示器 -->
            <div class="volume-indicator">
                <label class="volume-label">
                    音量检测 (超过阈值自动开始计时)
                    <span class="volume-threshold-label">阈值</span>
                </label>
                <div class="volume-bar-container">
                    <div class="volume-bar" id="volumeBar"></div>
                    <div class="volume-threshold-line"></div>
                </div>
            </div>

            <!-- 目标时长设置 -->
            <div class="target-duration">
                <label style="display: block; margin-bottom: 10px; color: #F57C00; font-weight: 700; font-size: 14px;">
                    目标时长
                </label>
                <div class="duration-presets">
                    <button type="button" class="duration-preset-btn active" onclick="setTargetDuration(5)">5秒</button>
                    <button type="button" class="duration-preset-btn" onclick="setTargetDuration(10)">10秒</button>
                    <button type="button" class="duration-preset-btn" onclick="setTargetDuration(15)">15秒</button>
                    <button type="button" class="duration-preset-btn" onclick="setTargetDuration(20)">20秒</button>
                    <button type="button" class="duration-preset-btn" onclick="setTargetDuration(30)">30秒</button>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="timer-controls">
                <button type="button" class="timer-btn primary" id="startMicBtn" onclick="startMicrophone()">
                    启用麦克风
                </button>
                <button type="button" class="timer-btn danger" id="stopMicBtn" onclick="stopMicrophone()" style="display: none;">
                    停止监听
                </button>
                <button type="button" class="timer-btn secondary" id="resetTimerBtn" onclick="resetTimer()">
                    重置
                </button>
            </div>

            <!-- 接水历史 -->
            <div class="history-section">
                <div class="history-title">接水历史</div>
                <div class="history-list" id="historyList">
                    <div class="no-history">暂无记录</div>
                </div>
            </div>

            <!-- 流速校准 -->
            <div class="calibration-section">
                <div class="calibration-title">
                    流速校准
                    <button type="button" class="calibration-toggle" id="calibrationToggle" onclick="toggleCalibration()">
                        展开校准
                    </button>
                </div>

                <div class="calibration-content" id="calibrationContent">
                    <!-- 流速显示 -->
                    <div class="flow-rate-display">
                        <div class="flow-rate-card hot">
                            <div class="flow-rate-label hot">🔥 热水流速</div>
                            <div class="flow-rate-value hot" id="hotFlowRate">--</div>
                            <div class="flow-rate-unit">ml/秒</div>
                        </div>
                        <div class="flow-rate-card cold">
                            <div class="flow-rate-label cold">❄️ 冷水流速</div>
                            <div class="flow-rate-value cold" id="coldFlowRate">--</div>
                            <div class="flow-rate-unit">ml/秒</div>
                        </div>
                    </div>

                    <!-- 校准模式选择 -->
                    <div class="calibration-mode-selector">
                        <button type="button" class="calibration-mode-btn active hot" id="calibrateHotBtn" onclick="selectCalibrationMode('hot')">
                            🔥 校准热水
                        </button>
                        <button type="button" class="calibration-mode-btn cold" id="calibrateColdBtn" onclick="selectCalibrationMode('cold')">
                            ❄️ 校准冷水
                        </button>
                    </div>

                    <!-- 输入容量 -->
                    <div class="calibration-input-group">
                        <label>请输入接水容量（毫升）</label>
                        <div class="calibration-input-wrapper">
                            <input type="number" id="calibrationVolume" placeholder="例如: 500" value="500" min="10" step="10">
                            <span style="color: #F57C00; font-weight: 700; font-size: 14px;">ml</span>
                        </div>
                    </div>

                    <!-- 校准结果显示 -->
                    <div class="calibration-result" id="calibrationResult" style="display: none;">
                        <div class="calibration-result-label">计算流速</div>
                        <div class="calibration-result-value" id="calibrationResultValue">--</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">ml/秒</div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="calibration-actions">
                        <button type="button" class="calibration-btn start" id="calibrationStartBtn" onclick="startCalibration()">
                            开始校准计时
                        </button>
                        <button type="button" class="calibration-btn save" id="calibrationSaveBtn" onclick="saveFlowRate()" disabled>
                            保存流速
                        </button>
                    </div>

                    <!-- 智能模式提示 -->
                    <div class="smart-mode-card">
                        <div class="smart-mode-title">💡 智能提示</div>
                        <div class="smart-mode-info">
                            完成热水和冷水流速校准后，在水温计算器中点击"计算"，系统会自动根据所需水量计算接水时长并更新目标时长设置。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 当前选择的温度和容量
        let currentTemp = 45;
        let currentCup = 1500;

        // 根据温度返回对应的颜色类名
        // 与期望水温按钮的颜色体系保持一致
        function getTempColorClass(temp) {
            if (temp < 30) return 'temp-very-cold';  // 0-30°C 深蓝
            if (temp < 50) return 'temp-cold';       // 30-50°C 蓝色
            if (temp <= 70) return 'temp-warm';      // 50-70°C 青绿色
            if (temp < 85) return 'temp-hot';        // 70-85°C 橙色
            return 'temp-very-hot';                  // 85-100°C 橙红色
        }

        // 毒舌提示语：目标温度过高（需要对水做功）
        const tooHotMessages = [
            '你需要对水做功 💪',
            '建议购买一个电热水壶 ☕',
            '物理学想和你聊聊热力学第二定律 📚',
            '混合两杯水就想突破能量守恒？天真 🤔',
            '要不试试把水放太阳底下晒晒？可能需要亿点点时间 ☀️',
            '恭喜你发现了永动机的秘密...才怪 ⚙️',
            '温馨提示：水不会自己变热的 🌡️'
        ];

        // 毒舌提示语：目标温度过低（脑子有水）
        const tooColdMessages = [
            '你需要先倒出你脑子里的水 🧠',
            '建议复习一下小学数学的平均数概念 📖',
            '两杯温水混一起能变冰水？你在逗我？🤨',
            '物理老师看了想打人系列 👨‍🏫',
            '要不要我帮你叫个冰箱？🧊',
            '醒醒，这是混合水温，不是魔法表演 ✨',
            '建议重修《物理常识与基本逻辑》🎓',
            '混合定律：最终温度只能在两者之间，懂？📐'
        ];

        // 随机获取提示语
        function getRandomMessage(messages) {
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // 限制输入框数值范围为0-100
        function limitTemperatureInput(input) {
            let value = parseFloat(input.value);
            if (isNaN(value)) return;

            if (value < 0) {
                input.value = 0;
            } else if (value > 100) {
                input.value = 100;
            }
        }

        // 自定义按钮改变数值
        function changeValue(inputId, step) {
            const input = document.getElementById(inputId);
            let currentValue = parseFloat(input.value) || 0;
            let newValue = currentValue + step;

            // 限制范围
            if (inputId === 'cupSize') {
                // 容量最小100
                if (newValue < 100) newValue = 100;
            } else {
                // 温度范围 0-100
                if (newValue < 0) newValue = 0;
                if (newValue > 100) newValue = 100;
            }

            input.value = newValue;

            // 触发input事件以便其他监听器响应
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 为所有温度输入框添加实时验证
        document.addEventListener('DOMContentLoaded', function() {
            const targetTempInput = document.getElementById('targetTemp');
            const hotTempInput = document.getElementById('hotTemp');
            const coldTempInput = document.getElementById('coldTemp');

            // 监听输入事件
            [targetTempInput, hotTempInput, coldTempInput].forEach(input => {
                input.addEventListener('input', function() {
                    limitTemperatureInput(this);
                });

                input.addEventListener('blur', function() {
                    limitTemperatureInput(this);
                });
            });
        });

        // 选择温度
        function selectTemp(value, event) {
            const clickedButton = event && event.target ? event.target : null;
            if (!clickedButton) return;

            // 找到当前按钮所在的按钮组
            const buttonGroup = clickedButton.closest('.button-group');
            if (!buttonGroup) return;

            // 清除同组所有按钮的active状态
            const buttons = buttonGroup.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            const customInput = document.getElementById('customTempInput');
            const targetTempInput = document.getElementById('targetTemp');

            if (value === 'custom') {
                clickedButton.classList.add('active');
                customInput.classList.add('show');
                targetTempInput.focus();
                currentTemp = parseFloat(targetTempInput.value) || 45;
            } else {
                clickedButton.classList.add('active');
                customInput.classList.remove('show');
                currentTemp = value;
                targetTempInput.value = value;
            }
        }

        // 选择杯子容量
        function selectCup(value, event) {
            const clickedButton = event && event.target ? event.target : null;
            if (!clickedButton) return;

            // 找到当前按钮所在的按钮组
            const buttonGroup = clickedButton.closest('.button-group');
            if (!buttonGroup) return;

            // 清除同组所有按钮的active状态
            const buttons = buttonGroup.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            const customInput = document.getElementById('customCupInput');
            const cupSizeInput = document.getElementById('cupSize');

            if (value === 'custom') {
                clickedButton.classList.add('active');
                customInput.classList.add('show');
                cupSizeInput.focus();
                currentCup = parseFloat(cupSizeInput.value) || 1500;
            } else {
                clickedButton.classList.add('active');
                customInput.classList.remove('show');
                currentCup = value;
                cupSizeInput.value = value;
            }
        }

        function calculate() {
            // 获取输入值
            const targetTemp = parseFloat(document.getElementById('targetTemp').value);
            const cupSize = parseFloat(document.getElementById('cupSize').value);
            const hotTemp = parseFloat(document.getElementById('hotTemp').value);
            const coldTemp = parseFloat(document.getElementById('coldTemp').value);

            const errorDiv = document.getElementById('error');
            const resultDiv = document.getElementById('result');

            // 隐藏之前的结果和错误
            errorDiv.classList.remove('show');

            // 如果结果已显示，需要先移除show类，等待动画结束后再重新添加
            const wasShown = resultDiv.classList.contains('show');
            if (wasShown) {
                resultDiv.classList.remove('show');
                // 等待一小段时间让移除生效
                void resultDiv.offsetWidth; // 强制重排
            }

            // 验证输入
            if (isNaN(targetTemp) || isNaN(cupSize) || isNaN(hotTemp) || isNaN(coldTemp)) {
                showError('请填写所有数值');
                return;
            }

            // 验证温度范围 0-100°C
            if (targetTemp < 0 || targetTemp > 100) {
                showError('期望温度必须在 0-100°C 之间');
                return;
            }

            if (hotTemp < 0 || hotTemp > 100) {
                showError('热水温度必须在 0-100°C 之间');
                return;
            }

            if (coldTemp < 0 || coldTemp > 100) {
                showError('凉水温度必须在 0-100°C 之间');
                return;
            }

            if (cupSize <= 0) {
                showError('杯子容量必须大于0');
                return;
            }

            if (hotTemp <= coldTemp) {
                showError('热水温度必须高于凉水温度');
                return;
            }

            // 检查目标温度是否可实现
            if (targetTemp > hotTemp) {
                // 目标温度比最热的水还热 - 需要对水做功
                showError(getRandomMessage(tooHotMessages));
                return;
            }

            if (targetTemp < coldTemp) {
                // 目标温度比最冷的水还冷 - 脑子有水
                showError(getRandomMessage(tooColdMessages));
                return;
            }

            // 计算热水和凉水的量
            // 公式：热水量 = 总量 × (期望温度 - 凉水温度) / (热水温度 - 凉水温度)
            const hotWater = cupSize * (targetTemp - coldTemp) / (hotTemp - coldTemp);
            const coldWater = cupSize - hotWater;

            // 根据温度设置不同的颜色主题
            let bgGradient, borderColor;
            if (targetTemp <= 50) {
                // 凉水 - 蓝色系
                bgGradient = 'linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%)';
                borderColor = '#81D4FA';
            } else if (targetTemp <= 70) {
                // 温水 - 青绿色系
                bgGradient = 'linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%)';
                borderColor = '#80CBC4';
            } else {
                // 热水 - 暖橙色系
                bgGradient = 'linear-gradient(135deg, #FBE9E7 0%, #FFCCBC 100%)';
                borderColor = '#FFAB91';
            }

            resultDiv.style.background = bgGradient;
            resultDiv.style.borderColor = borderColor;

            // 更新温度指示器
            const tempMarker = document.getElementById('tempMarker');
            const tempValue = document.getElementById('tempValue');
            // 温度范围假设为0-100°C，计算百分比位置
            const tempPercent = (targetTemp / 100) * 100;
            tempMarker.style.left = `${tempPercent}%`;
            tempValue.textContent = `${Math.round(targetTemp)}°C`;

            // 更新水位指示器 - 分层显示热水和冷水
            const waterHot = document.getElementById('waterHot');
            const waterCold = document.getElementById('waterCold');

            // 计算热水和冷水的百分比
            const hotPercent = (hotWater / cupSize) * 100;
            const coldPercent = (coldWater / cupSize) * 100;

            // 热水在底部,占据底部的百分比高度
            waterHot.style.height = `${hotPercent}%`;

            // 冷水叠加在热水上面,总高度应该是100%
            // 冷水的bottom位置应该从热水顶部开始
            waterCold.style.height = `${coldPercent}%`;
            waterCold.style.bottom = `${hotPercent}%`;

            // 更新水信息显示
            document.getElementById('totalVolume').textContent = `${Math.round(cupSize)}ml`;
            document.getElementById('hotWaterAmount').textContent = `${Math.round(hotWater)}ml`;
            document.getElementById('hotWaterPercent').textContent = `${Math.round(hotPercent)}%`;
            document.getElementById('coldWaterAmount').textContent = `${Math.round(coldWater)}ml`;
            document.getElementById('coldWaterPercent').textContent = `${Math.round(coldPercent)}%`;

            // 显示结果（默认先接热水）- 使用温度色谱系统
            const hotTempClass = getTempColorClass(hotTemp);
            const coldTempClass = getTempColorClass(coldTemp);
            const targetTempClass = getTempColorClass(targetTemp);

            document.getElementById('step1').innerHTML = `<span>先接</span><span class="temp-tag ${hotTempClass}">热水 ${Math.round(hotTemp)}°C</span><span> ${Math.round(hotWater)} 毫升</span>`;
            document.getElementById('step2').innerHTML = `<span>再接</span><span class="temp-tag ${coldTempClass}">凉水 ${Math.round(coldTemp)}°C</span><span> ${Math.round(coldWater)} 毫升</span>`;
            document.getElementById('step3').innerHTML = `<span>最终得到</span><span class="temp-tag ${targetTempClass}">${Math.round(targetTemp)}°C</span><span>的温水 ${Math.round(cupSize)} 毫升</span>`;

            // 保存计算结果供智能模式使用
            lastCalculatedHotWater = hotWater;
            lastCalculatedColdWater = coldWater;

            // 智能模式：如果已校准流速，自动计算并设置时长
            if (hotFlowRate > 0 && coldFlowRate > 0) {
                // 计算热水和冷水的接水时长
                const hotDuration = Math.ceil(hotWater / hotFlowRate);
                const coldDuration = Math.ceil(coldWater / coldFlowRate);

                // 显示智能提示
                const smartInfo = document.createElement('div');
                smartInfo.className = 'smart-mode-card';
                smartInfo.style.marginTop = '15px';
                smartInfo.innerHTML = `
                    <div class="smart-mode-title">🤖 智能计算</div>
                    <div class="smart-mode-info">
                        <strong>热水:</strong> ${Math.round(hotWater)}ml ÷ ${hotFlowRate.toFixed(1)}ml/s ≈ <strong>${hotDuration}秒</strong><br>
                        <strong>冷水:</strong> ${Math.round(coldWater)}ml ÷ ${coldFlowRate.toFixed(1)}ml/s ≈ <strong>${coldDuration}秒</strong><br>
                        <span style="color: #1B5E20; margin-top: 8px; display: block;">
                            💡 建议：先设置目标${hotDuration}秒接热水，完成后设置目标${coldDuration}秒接冷水
                        </span>
                    </div>
                `;

                // 移除之前的智能提示（如果有）
                const oldSmartInfo = resultDiv.querySelector('.smart-mode-card');
                if (oldSmartInfo) {
                    oldSmartInfo.remove();
                }

                // 添加到结果区域
                resultDiv.appendChild(smartInfo);
            }

            resultDiv.classList.add('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // 回车键触发计算
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                calculate();
            }
        });

        // ====== 水声计时器功能 ======
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let javascriptNode = null;
        let mediaStream = null;

        // 计时器状态
        let timerRunning = false;
        let startTime = 0;
        let elapsedTime = 0;
        let timerInterval = null;
        let targetDuration = 5; // 默认5秒

        // 音量检测参数
        const VOLUME_THRESHOLD = 0.3; // 音量阈值 (0-1)，超过此值认为正在接水
        const SILENCE_DURATION = 1000; // 静音持续时间（毫秒），超过此时间停止计时
        let lastSoundTime = 0;
        let isDetectingWater = false;

        // 提醒音频
        let alertSound = null;

        // 历史记录
        let waterHistory = [];

        // 流速校准相关
        let hotFlowRate = 0; // 热水流速 ml/秒
        let coldFlowRate = 0; // 冷水流速 ml/秒
        let currentCalibrationMode = 'hot'; // 当前校准模式: 'hot' 或 'cold'
        let isCalibrating = false;
        let calibrationStartTime = 0;
        let calibrationElapsedTime = 0;
        let lastCalculatedHotWater = 0; // 上次计算的热水量
        let lastCalculatedColdWater = 0; // 上次计算的冷水量

        // 初始化提醒音
        function initAlertSound() {
            // 创建一个简单的提示音
            if (!audioContext) return;

            alertSound = {
                play: function() {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
            };
        }

        // 启动麦克风
        async function startMicrophone() {
            try {
                // 请求麦克风权限
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                // 创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(mediaStream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                // 初始化提醒音
                initAlertSound();

                // 处理音频数据
                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);

                    // 计算平均音量 (0-1)
                    const average = array.reduce((a, b) => a + b) / array.length / 255;

                    // 更新音量指示器
                    updateVolumeBar(average);

                    // 检测水声
                    detectWaterSound(average);
                };

                // 更新UI
                updateStatus('监听中 - 等待水声...', false);
                document.getElementById('startMicBtn').style.display = 'none';
                document.getElementById('stopMicBtn').style.display = 'flex';

            } catch (error) {
                console.error('无法访问麦克风:', error);
                updateStatus('无法访问麦克风，请检查权限设置', false);
                alert('无法访问麦克风。请确保:\n1. 浏览器有麦克风权限\n2. 使用 HTTPS 或 localhost\n3. 麦克风没有被其他应用占用');
            }
        }

        // 停止麦克风
        function stopMicrophone() {
            if (javascriptNode) {
                javascriptNode.disconnect();
                javascriptNode = null;
            }
            if (analyser) {
                analyser.disconnect();
                analyser = null;
            }
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // 停止计时器
            if (timerRunning) {
                stopTimer();
            }

            // 更新UI
            updateStatus('已停止监听', false);
            document.getElementById('startMicBtn').style.display = 'flex';
            document.getElementById('stopMicBtn').style.display = 'none';
            updateVolumeBar(0);
        }

        // 更新音量指示器
        function updateVolumeBar(volume) {
            const volumeBar = document.getElementById('volumeBar');
            const percent = Math.min(volume * 100, 100);
            volumeBar.style.width = percent + '%';
        }

        // 检测水声
        function detectWaterSound(volume) {
            const now = Date.now();

            if (volume > VOLUME_THRESHOLD) {
                // 检测到水声
                lastSoundTime = now;

                if (!isDetectingWater) {
                    isDetectingWater = true;
                    updateStatus('检测到水声 - 正在接水...', true);
                }

                // 如果计时器未运行，开始计时
                if (!timerRunning) {
                    startTimer();
                }
            } else {
                // 音量低于阈值
                if (isDetectingWater && timerRunning) {
                    // 检查是否持续静音
                    if (now - lastSoundTime > SILENCE_DURATION) {
                        // 静音超过阈值时间，停止计时
                        stopTimer();
                        isDetectingWater = false;
                        updateStatus('监听中 - 等待水声...', false);
                    }
                }
            }
        }

        // 开始计时
        function startTimer() {
            if (timerRunning) return;

            timerRunning = true;
            startTime = Date.now() - elapsedTime;

            timerInterval = setInterval(updateTimerDisplay, 100);

            // 移除警告样式
            document.getElementById('timerTime').classList.remove('alert-active');
        }

        // 停止计时
        function stopTimer() {
            if (!timerRunning) return;

            timerRunning = false;
            clearInterval(timerInterval);

            // 记录到历史
            if (elapsedTime > 500) { // 只记录超过0.5秒的
                addToHistory(elapsedTime);
            }

            // 检查是否达到目标时长
            const seconds = elapsedTime / 1000;
            if (targetDuration > 0 && Math.abs(seconds - targetDuration) < 0.5) {
                updateStatus(`完成！接水 ${seconds.toFixed(1)} 秒`, false);
            }
        }

        // 更新计时显示
        function updateTimerDisplay() {
            if (!timerRunning) return;

            elapsedTime = Date.now() - startTime;
            const seconds = Math.floor(elapsedTime / 1000);
            const milliseconds = Math.floor((elapsedTime % 1000) / 100);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;

            const timeStr = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${milliseconds}`;
            document.getElementById('timerTime').textContent = timeStr;

            // 检查是否接近目标时长
            if (targetDuration > 0) {
                const currentSeconds = elapsedTime / 1000;
                const remaining = targetDuration - currentSeconds;

                if (remaining <= 0 && !document.getElementById('timerTime').classList.contains('alert-active')) {
                    // 达到目标时长
                    document.getElementById('timerTime').classList.add('alert-active');
                    updateStatus('⏰ 已达到目标时长！', true, true);

                    // 播放提醒音
                    if (alertSound) {
                        alertSound.play();
                        // 连续播放3次
                        setTimeout(() => alertSound.play(), 300);
                        setTimeout(() => alertSound.play(), 600);
                    }

                    // 振动提醒（如果支持）
                    if ('vibrate' in navigator) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    }
                }
            }
        }

        // 重置计时器
        function resetTimer() {
            if (timerRunning) {
                stopTimer();
            }
            elapsedTime = 0;
            document.getElementById('timerTime').textContent = '00:00.0';
            document.getElementById('timerTime').classList.remove('alert-active');

            if (audioContext) {
                updateStatus('监听中 - 等待水声...', false);
            }
        }

        // 设置目标时长
        function setTargetDuration(seconds) {
            targetDuration = seconds;
            document.getElementById('timerTarget').textContent = `目标时长: ${seconds}秒`;

            // 更新按钮状态
            document.querySelectorAll('.duration-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 更新状态显示
        function updateStatus(message, isActive, isWarning) {
            const statusDiv = document.getElementById('timerStatus');
            statusDiv.textContent = message;
            statusDiv.classList.remove('active', 'warning');

            if (isWarning) {
                statusDiv.classList.add('warning');
            } else if (isActive) {
                statusDiv.classList.add('active');
            }
        }

        // 添加到历史记录
        function addToHistory(duration) {
            const seconds = (duration / 1000).toFixed(1);
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            waterHistory.unshift({ duration: seconds, time: time });

            // 只保留最近10条
            if (waterHistory.length > 10) {
                waterHistory = waterHistory.slice(0, 10);
            }

            updateHistoryDisplay();
        }

        // 更新历史记录显示
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');

            if (waterHistory.length === 0) {
                historyList.innerHTML = '<div class="no-history">暂无记录</div>';
                return;
            }

            historyList.innerHTML = waterHistory.map(item => `
                <div class="history-item">
                    <span class="history-duration">${item.duration}秒</span>
                    <span class="history-time">${item.time}</span>
                </div>
            `).join('');
        }

        // ====== 流速校准功能 ======

        // 从localStorage加载流速数据
        function loadFlowRates() {
            const savedHot = localStorage.getItem('hotFlowRate');
            const savedCold = localStorage.getItem('coldFlowRate');

            if (savedHot) {
                hotFlowRate = parseFloat(savedHot);
                document.getElementById('hotFlowRate').textContent = hotFlowRate.toFixed(1);
            }

            if (savedCold) {
                coldFlowRate = parseFloat(savedCold);
                document.getElementById('coldFlowRate').textContent = coldFlowRate.toFixed(1);
            }
        }

        // 保存流速数据到localStorage
        function saveFlowRatesToStorage() {
            if (hotFlowRate > 0) {
                localStorage.setItem('hotFlowRate', hotFlowRate.toString());
            }
            if (coldFlowRate > 0) {
                localStorage.setItem('coldFlowRate', coldFlowRate.toString());
            }
        }

        // 切换校准面板
        function toggleCalibration() {
            const content = document.getElementById('calibrationContent');
            const toggle = document.getElementById('calibrationToggle');

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = '展开校准';
                toggle.classList.remove('active');
            } else {
                content.classList.add('show');
                toggle.textContent = '收起校准';
                toggle.classList.add('active');
            }
        }

        // 选择校准模式
        function selectCalibrationMode(mode) {
            currentCalibrationMode = mode;

            // 更新按钮状态
            const hotBtn = document.getElementById('calibrateHotBtn');
            const coldBtn = document.getElementById('calibrateColdBtn');

            if (mode === 'hot') {
                hotBtn.classList.add('active');
                coldBtn.classList.remove('active');
            } else {
                coldBtn.classList.add('active');
                hotBtn.classList.remove('active');
            }

            // 如果正在校准，停止
            if (isCalibrating) {
                stopCalibration();
            }
        }

        // 开始校准
        function startCalibration() {
            const volume = parseFloat(document.getElementById('calibrationVolume').value);

            if (!volume || volume <= 0) {
                alert('请输入有效的接水容量');
                return;
            }

            // 确保麦克风已启动
            if (!audioContext) {
                alert('请先启用麦克风');
                return;
            }

            // 重置普通计时器
            if (timerRunning) {
                stopTimer();
            }
            elapsedTime = 0;
            document.getElementById('timerTime').textContent = '00:00.0';

            // 开始校准计时
            isCalibrating = true;
            calibrationStartTime = 0; // 会在检测到水声时设置
            calibrationElapsedTime = 0;

            // 更新按钮状态
            document.getElementById('calibrationStartBtn').textContent = '等待水声...';
            document.getElementById('calibrationStartBtn').disabled = true;
            document.getElementById('calibrationSaveBtn').disabled = true;
            document.getElementById('calibrationResult').style.display = 'none';

            // 更新状态
            const waterType = currentCalibrationMode === 'hot' ? '热水' : '冷水';
            updateStatus(`校准模式 - 请开始接${waterType} ${volume}ml`, true);
        }

        // 停止校准
        function stopCalibration() {
            if (!isCalibrating) return;

            isCalibrating = false;
            const volume = parseFloat(document.getElementById('calibrationVolume').value);

            if (calibrationElapsedTime > 500) {
                // 计算流速
                const seconds = calibrationElapsedTime / 1000;
                const flowRate = volume / seconds;

                // 显示结果
                document.getElementById('calibrationResultValue').textContent = flowRate.toFixed(1);
                document.getElementById('calibrationResult').style.display = 'block';

                // 启用保存按钮
                document.getElementById('calibrationSaveBtn').disabled = false;

                updateStatus(`校准完成！流速: ${flowRate.toFixed(1)} ml/秒`, false);
            } else {
                updateStatus('校准时间太短，请重试', false);
            }

            // 恢复按钮
            document.getElementById('calibrationStartBtn').textContent = '开始校准计时';
            document.getElementById('calibrationStartBtn').disabled = false;

            // 重置计时
            calibrationStartTime = 0;
            calibrationElapsedTime = 0;
        }

        // 保存流速
        function saveFlowRate() {
            const resultValue = document.getElementById('calibrationResultValue').textContent;
            const flowRate = parseFloat(resultValue);

            if (!flowRate || flowRate <= 0) return;

            if (currentCalibrationMode === 'hot') {
                hotFlowRate = flowRate;
                document.getElementById('hotFlowRate').textContent = flowRate.toFixed(1);
            } else {
                coldFlowRate = flowRate;
                document.getElementById('coldFlowRate').textContent = flowRate.toFixed(1);
            }

            // 保存到localStorage
            saveFlowRatesToStorage();

            // 提示
            const waterType = currentCalibrationMode === 'hot' ? '热水' : '冷水';
            updateStatus(`${waterType}流速已保存: ${flowRate.toFixed(1)} ml/秒`, false);

            // 禁用保存按钮
            document.getElementById('calibrationSaveBtn').disabled = true;

            // 隐藏结果
            setTimeout(() => {
                document.getElementById('calibrationResult').style.display = 'none';
            }, 2000);
        }

        // 修改检测水声函数，支持校准模式
        const originalDetectWaterSound = detectWaterSound;
        detectWaterSound = function(volume) {
            const now = Date.now();

            if (volume > VOLUME_THRESHOLD) {
                // 检测到水声
                lastSoundTime = now;

                if (!isDetectingWater) {
                    isDetectingWater = true;

                    if (isCalibrating) {
                        const waterType = currentCalibrationMode === 'hot' ? '热水' : '冷水';
                        updateStatus(`检测到${waterType} - 校准计时中...`, true);
                    } else {
                        updateStatus('检测到水声 - 正在接水...', true);
                    }
                }

                // 校准模式
                if (isCalibrating) {
                    if (calibrationStartTime === 0) {
                        calibrationStartTime = now;
                    }
                    calibrationElapsedTime = now - calibrationStartTime;

                    // 更新计时显示
                    const seconds = Math.floor(calibrationElapsedTime / 1000);
                    const milliseconds = Math.floor((calibrationElapsedTime % 1000) / 100);
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${milliseconds}`;
                    document.getElementById('timerTime').textContent = timeStr;
                } else {
                    // 普通模式
                    if (!timerRunning) {
                        startTimer();
                    }
                }
            } else {
                // 音量低于阈值
                if (isDetectingWater) {
                    // 检查是否持续静音
                    if (now - lastSoundTime > SILENCE_DURATION) {
                        // 静音超过阈值时间
                        if (isCalibrating) {
                            stopCalibration();
                        } else {
                            stopTimer();
                        }
                        isDetectingWater = false;

                        if (audioContext && !isCalibrating) {
                            updateStatus('监听中 - 等待水声...', false);
                        }
                    }
                }
            }
        };

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查浏览器是否支持音频API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('浏览器不支持麦克风功能', false);
                document.getElementById('startMicBtn').disabled = true;
            }

            // 初始化目标时长显示
            setTargetDuration(5);

            // 加载保存的流速数据
            loadFlowRates();
        });
    </script>
</body>
</html>
